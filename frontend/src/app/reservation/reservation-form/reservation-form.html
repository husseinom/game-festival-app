<form [formGroup]="form" (ngSubmit)="onSubmit($event)" class="reservation-form">
  <div class="form-section">
    <h2>{{ 'Nouvelle r√©servation' }}</h2>

    <div class="form-group">
      <label for="festival_id">Festival</label>
      <select
        id="festival_id"
        formControlName="festival_id"
      >
        <option value="" disabled>S√©lectionner un festival</option>
        @for (festival of festivals(); track festival.id) {
          <option [value]="festival.id">
            {{ festival.name }} - {{ festival.location }}
          </option>
        }
      </select>
      @if (form.get('festival_id')?.hasError('required')) {
        <span class="error">
          Le festival est obligatoire
        </span>
      }
    </div>

    <div class="form-group">
      <label for="game_publisher_id">√âditeur de jeu (provenance des jeux)</label>
      <select
        id="game_publisher_id"
        formControlName="game_publisher_id"
      >
        <option value="" disabled>S√©lectionner un √©diteur</option>
        @for (publisher of gamePublishers(); track publisher.id) {
          <option [value]="publisher.id">
            {{ publisher.name }}
          </option>
        }
      </select>
      @if (form.get('game_publisher_id')?.hasError('required') && publisherIsReservant()) {
        <span class="error">
          L'√©diteur est obligatoire quand il r√©serve pour lui-m√™me
        </span>
      }
    </div>

    <!-- Option: L'√©diteur r√©serve pour lui-m√™me -->
    <div class="publisher-reservant-option">
      <label class="toggle-label">
        <input 
          type="checkbox" 
          [checked]="publisherIsReservant()"
          (change)="togglePublisherIsReservant()"
        />
        <span class="toggle-text">üè¢ L'√©diteur r√©serve pour lui-m√™me</span>
      </label>
      @if (publisherIsReservant()) {
        <p class="option-hint">
          Un r√©servant sera automatiquement cr√©√© avec le nom et le type "√âditeur" de l'√©diteur s√©lectionn√© ci-dessus.
        </p>
      }
    </div>

    @if (!publisherIsReservant()) {
      <div class="form-group">
        <label for="reservant_id">R√©servant</label>
        <select
          id="reservant_id"
          formControlName="reservant_id"
        >
          <option value="" disabled>S√©lectionner un r√©servant</option>
          @for (reservant of reservants(); track reservant.reservant_id) {
            <option [value]="reservant.reservant_id">
              {{ reservant.name }} ({{ reservant.type | reservantTypeLabel }})
            </option>
          }
        </select>
        @if (form.get('reservant_id')?.hasError('required')) {
          <span class="error">
            Le r√©servant est obligatoire
          </span>
        }
      </div>
    }

    <div class="form-group">
      <label for="status">Statut</label>
      <select
        id="status"
        formControlName="status"
      >
        <option value="NOT_CONTACTED">Pas contact√©</option>
        <option value="CONTACTED">Contact pris</option>
        <option value="IN_DISCUSSION">Discussion en cours</option>
        <option value="CONFIRMED">Pr√©sent</option>
        <option value="ABSENT">Absent</option>
        <option value="CONSIDERED_ABSENT">Consid√©r√© absent</option>
      </select>
    </div>

    <div class="form-group">
      <label for="comments">Commentaires</label>
      <textarea
        id="comments"
        formControlName="comments"
        placeholder="Commentaires"
        rows="4"
      ></textarea>
    </div>

    <div class="form-group">
      <label for="large_table_request">Demande de grandes tables</label>
      <textarea
        id="large_table_request"
        formControlName="large_table_request"
        placeholder="D√©tails de la demande de grandes tables (ex: 2 tables 180cm pour d√©mo)"
        rows="2"
      ></textarea>
    </div>

    <div class="checkbox-group">
      <label>
        <input type="checkbox" formControlName="is_publisher_presenting" />
        √âditeur pr√©sent
      </label>
      <label>
        <input type="checkbox" formControlName="needs_festival_animators" />
        Besoin d'animateurs du festival
      </label>
    </div>

    <div class="form-group">
      <label for="discount_amount">Montant de la r√©duction</label>
      <input
        type="number"
        id="discount_amount"
        formControlName="discount_amount"
        placeholder="Montant de r√©duction"
        step="0.01"
      />
    </div>

    <div class="form-group">
      <label for="discount_tables">Nombre de tables de r√©duction</label>
      <input
        type="number"
        id="discount_tables"
        formControlName="discount_tables"
        placeholder="Nombre de tables"
      />
    </div>

    <div class="form-group">
      <label for="nb_electrical_outlets">Nombre de prises √©lectriques</label>
      <input
        type="number"
        id="nb_electrical_outlets"
        formControlName="nb_electrical_outlets"
        placeholder="Nombre de prises √©lectriques"
        min="0"
      />
      <small class="form-text">250‚Ç¨ par prise √©lectrique</small>
      @if (form.get('nb_electrical_outlets')?.hasError('required')) {
        <span class="error">
          Le nombre de prises est obligatoire
        </span>
      }
      @if (form.get('nb_electrical_outlets')?.hasError('min')) {
        <span class="error">
          Le nombre doit √™tre au moins 0
        </span>
      }
    </div>
  </div>

  <div class="form-section">
    <h3>Zones de prix</h3>
    <div formArrayName="tables">
      @for (table of tablesArray.controls; track i; let i = $index) {
        <div
          [formGroupName]="i"
          class="table-entry"
        >
          <div class="form-group">
          <label [for]="'price_zone_' + i">Zone de prix</label>
          <select
            [id]="'price_zone_' + i"
            formControlName="price_zone_id"
          >
            <option value="" disabled>S√©lectionner une zone</option>
            @for (zone of priceZones(); track zone.id) {
              <option [value]="zone.id">
                {{ zone.name }}
              </option>
            }
          </select>
          @if (form.get('tables')?.get([i, 'price_zone_id'])?.hasError('required')) {
            <span class="error">
              La zone est obligatoire
            </span>
          }
        </div>

        <div class="form-group">
          <label [for]="'table_count_' + i">Nombre de tables</label>
          <input
            type="number"
            [id]="'table_count_' + i"
            formControlName="table_count"
            placeholder="Nombre de tables"
            min="1"
          />
          @if (form.get('tables')?.get([i, 'table_count'])?.hasError('required')) {
            <span class="error">
              Le nombre de tables est obligatoire
            </span>
          }
          @if (form.get('tables')?.get([i, 'table_count'])?.hasError('min')) {
            <span class="error">
              Le nombre doit √™tre au moins 1
            </span>
          }
        </div>

        <button type="button" (click)="removeTable(i)" class="btn-remove">
          Supprimer
        </button>
      </div>
      }
    </div>

    <button type="button" (click)="addTable()" class="btn-add">
      + Ajouter une zone
    </button>
  </div>

  <div class="form-actions">
    <button type="submit" [disabled]="form.invalid" class="btn-submit">
      {{ 'Cr√©er' }}
    </button>
  </div>
</form>
