<form [formGroup]="form" (ngSubmit)="onSubmit($event)" class="reservation-form">
  <div class="form-section">
    <h2>{{ 'Nouvelle r√©servation' }}</h2>

    <div class="form-group">
      <label for="festival_id">Festival</label>
      <select
        id="festival_id"
        formControlName="festival_id"
      >
        <option [value]="null" disabled>S√©lectionner un festival</option>
        @for (festival of festivals(); track festival.id) {
          <option [value]="festival.id">
            {{ festival.name }} - {{ festival.location }}
          </option>
        }
      </select>
      @if (form.get('festival_id')?.hasError('required') && form.get('festival_id')?.touched) {
        <span class="error">
          Le festival est obligatoire
        </span>
      }
    </div>

    <div class="form-group">
      <label for="reservant_id">R√©servant *</label>
      <select
        id="reservant_id"
        formControlName="reservant_id"
      >
        <option [value]="null" disabled>S√©lectionner un r√©servant</option>
        @for (reservant of reservants(); track reservant.reservant_id) {
          <option [value]="reservant.reservant_id">
            {{ reservant.name }} - {{ reservant.type }}
          </option>
        }
      </select>
      @if (form.get('reservant_id')?.hasError('required') && form.get('reservant_id')?.touched) {
        <span class="error">
          Le r√©servant est obligatoire
        </span>
      }
    </div>

    <div class="form-group">
      <label for="game_publisher_id">√âditeur de jeu (optionnel)</label>
      <select
        id="game_publisher_id"
        formControlName="game_publisher_id"
      >
        <option [value]="null">Aucun √©diteur</option>
        @for (publisher of gamePublishers(); track publisher.id) {
          <option [value]="publisher.id">
            {{ publisher.name }}
          </option>
        }
      </select>
    </div>

    <div class="form-group">
      <label for="status">Statut</label>
      <select id="status" formControlName="status">
        <option value="Contact pris">Contact pris</option>
        <option value="En discussion">En discussion</option>
        <option value="Confirm√©">Confirm√©</option>
        <option value="Factur√©">Factur√©</option>
        <option value="Annul√©">Annul√©</option>
      </select>
    </div>

    <div class="form-group">
      <label for="comments">Commentaires</label>
      <textarea
        id="comments"
        formControlName="comments"
        placeholder="Commentaires"
        rows="4"
      ></textarea>
    </div>

    <div class="checkbox-group">
      <label>
        <input type="checkbox" formControlName="is_publisher_presenting" />
        √âditeur pr√©sent
      </label>
      <label>
        <input type="checkbox" formControlName="game_list_requested" />
        Liste des jeux demand√©e
      </label>
      <label>
        <input type="checkbox" formControlName="game_list_received" />
        Liste des jeux re√ßue
      </label>
      <label>
        <input type="checkbox" formControlName="games_received" />
        Jeux re√ßus
      </label>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="discount_amount">Montant de la r√©duction (‚Ç¨)</label>
        <input
          type="number"
          id="discount_amount"
          formControlName="discount_amount"
          placeholder="0.00"
          step="0.01"
          min="0"
        />
      </div>

      <div class="form-group">
        <label for="discount_tables">Nombre de tables de r√©duction</label>
        <input
          type="number"
          id="discount_tables"
          formControlName="discount_tables"
          placeholder="0"
          min="0"
        />
      </div>
    </div>

    <div class="form-group">
      <label for="nb_electrical_outlets">Nombre de prises √©lectriques *</label>
      <input
        type="number"
        id="nb_electrical_outlets"
        formControlName="nb_electrical_outlets"
        placeholder="0"
        min="0"
      />
      <small class="form-text">250‚Ç¨ par prise √©lectrique</small>
      @if (form.get('nb_electrical_outlets')?.hasError('required') && form.get('nb_electrical_outlets')?.touched) {
        <span class="error">
          Le nombre de prises est obligatoire
        </span>
      }
      @if (form.get('nb_electrical_outlets')?.hasError('min')) {
        <span class="error">
          Le nombre doit √™tre au moins 0
        </span>
      }
    </div>
  </div>

  <div class="form-section">
    <div class="section-header">
      <h3>Zones de prix et tables</h3>
      @if (!selectedFestivalId) {
        <p class="warning-message">
          ‚ö†Ô∏è Veuillez d'abord s√©lectionner un festival pour ajouter des zones
        </p>
      }
    </div>

    <div formArrayName="tables">
      @for (table of tablesArray.controls; track i; let i = $index) {
        <div
          [formGroupName]="i"
          class="table-entry"
        >
          <div class="form-group">
            <label [for]="'price_zone_' + i">Zone de prix *</label>
            <select
              [id]="'price_zone_' + i"
              formControlName="price_zone_id"
            >
              <option [value]="null" disabled>S√©lectionner une zone</option>
              @for (zone of filteredPriceZones(); track zone.id) {
                <option [value]="zone.id">
                  {{ zone.name }} - {{ zone.table_price }}‚Ç¨/table ({{ zone.total_tables }} tables disponibles)
                </option>
              }
            </select>
            @if (form.get('tables')?.get([i, 'price_zone_id'])?.hasError('required') && form.get('tables')?.get([i, 'price_zone_id'])?.touched) {
              <span class="error">
                La zone est obligatoire
              </span>
            }
          </div>

          <div class="form-group">
            <label [for]="'table_count_' + i">
              Nombre de tables * 
              @if (tablesArray.at(i).get('price_zone_id')?.value) {
                <span class="max-info">(Max: {{ getMaxTablesForZone(tablesArray.at(i).get('price_zone_id')?.value) }})</span>
              }
            </label>
            <input
              type="number"
              [id]="'table_count_' + i"
              formControlName="table_count"
              placeholder="1"
              min="1"
              [max]="getMaxTablesForZone(tablesArray.at(i).get('price_zone_id')?.value)"
            />
            @if (form.get('tables')?.get([i, 'table_count'])?.hasError('required') && form.get('tables')?.get([i, 'table_count'])?.touched) {
              <span class="error">
                Le nombre de tables est obligatoire
              </span>
            }
            @if (form.get('tables')?.get([i, 'table_count'])?.hasError('min')) {
              <span class="error">
                Le nombre doit √™tre au moins 1
              </span>
            }
            @if (tablesArray.at(i).get('table_count')?.value > getMaxTablesForZone(tablesArray.at(i).get('price_zone_id')?.value)) {
              <span class="error">
                Maximum {{ getMaxTablesForZone(tablesArray.at(i).get('price_zone_id')?.value) }} tables disponibles dans {{ getPriceZoneName(tablesArray.at(i).get('price_zone_id')?.value) }}
              </span>
            }
          </div>

          <button type="button" (click)="removeTable(i)" class="btn-remove" title="Supprimer cette zone">
            üóëÔ∏è Supprimer
          </button>
        </div>
      }

      @if (tablesArray.length === 0) {
        <p class="empty-message">Aucune zone ajout√©e. Cliquez sur "Ajouter une zone" pour commencer.</p>
      }
    </div>

    <button 
      type="button" 
      (click)="addTable()" 
      class="btn-add"
      [disabled]="!selectedFestivalId"
      [title]="!selectedFestivalId ? 'S√©lectionnez d\'abord un festival' : 'Ajouter une zone de prix'"
    >
      + Ajouter une zone
    </button>
  </div>

  <div class="form-actions">
    <button type="submit" [disabled]="form.invalid" class="btn-submit">
      Cr√©er la r√©servation
    </button>
  </div>
</form>
