datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

generator client {
    provider = "prisma-client-js"
}

enum Role {
    ADMIN
    VISITOR
    VOLUNTEER
    ORGANISATOR
    SUPER_ORGANISATOR
}

model User {
    id          Int         @id @default(autoincrement())

    name        String
    email       String      @unique
    password    String

    role        Role        @default(VISITOR)
}

model Festival {
    id              Int         @id @default(autoincrement())
    
    name            String
    location        String
    total_tables    Int
    startDate       DateTime
    endDate         DateTime
    priceZoneTypeId  Int?
    priceZoneType    PriceZoneType?  @relation(fields: [priceZoneTypeId], references: [id])
    priceZones      PriceZone[]

    // add opposite relation for MapZone
    mapZones        MapZone[]

    // Reservations for this festival
    reservations    Reservation[]

    @@unique([name, location, startDate])
}

model GamePublisher {
    id           Int     @id @default(autoincrement())
    name         String
    exposant     Boolean @default(false)
    distributeur Boolean @default(false)
    logoUrl      String? 

    games        Game[]
    reservations Reservation[]
    contacts     Contact[]
}

model GameType {
    id    Int    @id @default(autoincrement())
    label String
    games Game[]
}

model MapZone{
    id     Int  @id @default(autoincrement())
    festival_id Int
    festival Festival  @relation(fields: [festival_id], references: [id], onDelete: Cascade)
    price_zone_id Int
    price_zone PriceZone @relation(fields: [price_zone_id], references: [id])
    name String

    festivalGames  FestivalGame[]
    tableTypes     TableType[]
}

model PriceZoneType{
    id     Int     @id @default(autoincrement())
    key    String  @unique
    name   String
    festivals Festival[]
}

model PriceZone{
    id  Int   @id @default(autoincrement())
    festival_id Int
    festival Festival @relation(fields: [festival_id], references: [id], onDelete: Cascade)
    name  String
    table_price Float
    total_tables  Int?

    mapZones MapZone[]
    zoneReservations ZoneReservation[]

}

model GameMechanism {
    id          Int     @id @default(autoincrement())
    label       String
    description String? @db.Text
    games       Game[]
}

model Game {
    id          Int      @id @default(autoincrement())
    name        String
    author      String?
    minPlayers  Int?
    maxPlayers  Int?
    minAge      Int?
    duration    Int?
    prototype   Boolean  @default(false)
    theme       String?  @db.Text
    description String?  @db.Text
    imageUrl    String?
    noticeUrl   String?
    videoUrl    String?

    // Relations
    publisherId Int?
    publisher   GamePublisher? @relation(fields: [publisherId], references: [id])

    typeId      Int?
    type        GameType?      @relation(fields: [typeId], references: [id])

    mechanisms  GameMechanism[]
    festivalGames FestivalGame[]
}

model Reservant {
    reservant_id    Int     @id @default(autoincrement())

    name            String
    type            String
    reservations    Reservation[]
}

model Reservation {
    reservation_id           Int     @id @default(autoincrement())

    game_publisher_id        Int?
    festival_id              Int
    reservant_id             Int

    status                   String
    comments                 String?

    is_publisher_presenting  Boolean @default(false)
    game_list_requested      Boolean @default(false)
    game_list_received       Boolean @default(false)
    games_received           Boolean @default(false)

    discount_amount          Float?
    discount_tables          Int?
    nb_electrical_outlets    Int
    final_invoice_amount     Float?

    // Relations
    publisher               GamePublisher? @relation(fields: [game_publisher_id], references: [id])
    festival                Festival       @relation(fields: [festival_id], references: [id], onDelete: Cascade)
    reservant               Reservant      @relation(fields: [reservant_id], references: [reservant_id])
    zones                   ZoneReservation[]
    games                   FestivalGame[]
    contactLogs             ContactLog[]

    @@index([game_publisher_id])
    @@index([festival_id])
    @@index([reservant_id])
}

model ZoneReservation {
  id             Int         @id @default(autoincrement())
  reservation_id Int
  price_zone_id  Int
  table_count    Int         @default(0) // "table_nb"

  reservation    Reservation @relation(fields: [reservation_id], references: [reservation_id])
  priceZone      PriceZone   @relation(fields: [price_zone_id], references: [id])

  @@unique([reservation_id, price_zone_id]) // Un éditeur ne peut pas avoir 2 lignes pour la même zone dans la même résa
}

model FestivalGame {
  id              Int         @id @default(autoincrement())
  reservation_id  Int
  game_id         Int
  map_zone_id     Int?        // Peut être null tant que l'orga ne l'a pas placé
  
  copy_count      Int         @default(1) // Nombre d'exemplaires du jeu
  allocated_tables Int        @default(1) // Combien de tables ça prend

  reservation     Reservation @relation(fields: [reservation_id], references: [reservation_id])
  game            Game        @relation(fields: [game_id], references: [id])
  mapZone         MapZone?    @relation(fields: [map_zone_id], references: [id])
}

model TableType {
  id              Int      @id @default(autoincrement())
  name            String   // "small", "large", "city"
  nb_total        Int      // Stock total disponible
  nb_total_player Int      // Capacité joueurs (ex: 4)
  
  map_zone_id     Int
  mapZone         MapZone  @relation(fields: [map_zone_id], references: [id])
}

model Contact {
  id                Int           @id @default(autoincrement())
  game_publisher_id Int
  name              String
  email             String
  tel               String?

  publisher         GamePublisher @relation(fields: [game_publisher_id], references: [id])
}

model ContactLog {
  id             Int         @id @default(autoincrement())
  reservation_id Int
  contact_date   DateTime    @default(now())
  notes          String?     @db.Text

  reservation    Reservation @relation(fields: [reservation_id], references: [reservation_id])
}